---
title: "COVID-19 in Victoria"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
    theme: cosmo
    includes:
        in_header: goo_anal.htm
---

<style>                     
.value-box .icon .fa {
font-size: 180%;
color: rgba(255, 255, 255, 0.8);
top: 7px;
}
.value-box .value {
font-size: 23px;
margin: -5px 0 3px 0;
}
.value-box h6 {
font-size: 20px;
font-weight: bold;
margin-top: -8px;
}
.r0 {
margin-right: 72%;
}
h3 {
font-size:19px;
margin-right: 20px;
margin-top: 10.5px;
margin-bottom: 10.5px;
display: block;
font-weight: bold;
font-family: "Source Sans Pro",Calibri,Candara,Arial,sans-serif;
line-height: 1.1;
color: inherit;
}
.navbar{
  visibility: hidden
}
body {
    padding-top: 10px;
}
</style>

```{r include = FALSE}
# knitr::opts_chunk$set(echo=FALSE, message=FALSE,warning=FALSE)
# rmarkdown::render(input='covid_plots.Rmd', output_file = "index.html")
```

```{r message=FALSE, warning=FALSE}
# library(ggplot2)
library(tidyverse)
library(RCurl)
library(plotly)
library(RColorBrewer)
library(flexdashboard)
library(shiny)
```

```{r}
# https://stackoverflow.com/questions/18332463/convert-written-number-to-number-in-r
word2num <- function(word){
    wsplit <- strsplit(tolower(word)," ")[[1]]
    one_digits <- list(zero=0, one=1, two=2, three=3, four=4, five=5,
                       six=6, seven=7, eight=8, nine=9)
    teens <- list(eleven=11, twelve=12, thirteen=13, fourteen=14, fifteen=15,
                  sixteen=16, seventeen=17, eighteen=18, nineteen=19)
    ten_digits <- list(ten=10, twenty=20, thirty=30, forty=40, fifty=50,
                       sixty=60, seventy=70, eighty=80, ninety=90)
    doubles <- c(teens,ten_digits)
    out <- 0
    i <- 1
    while(i <= length(wsplit)){
        j <- 1
        if(i==1 && wsplit[i]=="hundred")
            temp <- 100
        else if(i==1 && wsplit[i]=="thousand")
            temp <- 1000
        else if(wsplit[i] %in% names(one_digits))
            temp <- as.numeric(one_digits[wsplit[i]])
        else if(wsplit[i] %in% names(teens))
            temp <- as.numeric(teens[wsplit[i]])
        else if(wsplit[i] %in% names(ten_digits))
            temp <- (as.numeric(ten_digits[wsplit[i]]))
        if (!exists("temp")) {
          return(NA)
        }
        if(i < length(wsplit) && wsplit[i+1]=="hundred"){
            if(i>1 && wsplit[i-1] %in% c("hundred","thousand"))
                out <- out + 100*temp
            else
                out <- 100*(out + temp)
            j <- 2
        }
        else if(i < length(wsplit) && wsplit[i+1]=="thousand"){
            if(i>1 && wsplit[i-1] %in% c("hundred","thousand"))
                out <- out + 1000*temp
            else
                out <- 1000*(out + temp)
            j <- 2
        }
        else if(i < length(wsplit) && wsplit[i+1] %in% names(doubles)){
            temp <- temp*100
            out <- out + temp
        }
        else{
            out <- out + temp
        }
        i <- i + j
    }
    # return(list(word,out))
    return(out)
}
# word2num("four fifty seven")
# word2num("three")[[2]]
```

```{r}
# numbers only
numbers_only <- function(x) grepl("^[0-9]+([,.])?$", x)
# clean HTML
cleanHTML <- function(htmlString) {
  htmlString <- gsub(".&nbsp;", "", htmlString, fixed =TRUE)
  htmlString <- gsub(". &nbsp;", " ", htmlString, fixed =TRUE)
  htmlString <- gsub("&nbsp;", " ", htmlString, fixed =TRUE)
  htmlString <- gsub("\\.<.*?>", "", htmlString)
  htmlString <- gsub("\\.<.*?>", "", htmlString)
  htmlString <- gsub("\\t", "", htmlString)
  return(gsub("<.*?>", "", htmlString))
  }
```


```{r}
fix_old_reports <- function(cdata){
  cdata[1,is.na(cdata[1,])] <- c(355,6,0,97)
  cdata[2,c(4,7)] <- c(411,113)
  cdata[3,7] <- 128
  cdata[4,c(4,7)] <- c(520,149)
  cdata[8,c(6,7)] <- c(4,248)
  cdata$deaths[c(14,16)] <- c(8,11)
  # 7 april break of line for transmission
  cdata$community[16] <- 93
  # 16 april no web report (I did 13 just to run the code)
  cdata[25,c(1:3)] <- c("april","16","2020-04-16")
  cdata[25,c(4:9)]<- c(1301,39,18,1137,14,132)
  cdata[54,4] <- 1543
  # 17 may no web report (I did 6 just to run the code)
  cdata[56,c(1:3)] <- c("may","17","2020-05-17")
  cdata[56,c(4:9)]<- c(1561,11,7,1417,18,160)
  cdata[68,'icu'] <- 2
  cdata[68,'recovered'] <- 1549
  return(cdata)
}
```

```{r}
get_dhhs_url <- function(day,month){
  day.bkp <- day
  url.prefix <- ''
  dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month,'-2020')
  dhhs.url <- gsub(" ","",dhhs.url)
  months <- 1:12
  names(months) <- tolower(month.name)
  weekday <- tolower(weekdays(as.Date(paste0(2020,"-",unname(months[month]),"-",day))))
  if (!url.exists(dhhs.url)) {
      dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month)
      if (!url.exists(dhhs.url)) {
          dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month)
          if (!url.exists(dhhs.url)) {
              dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month,'-2020')
          }
      }
  }
  if (!url.exists(dhhs.url)) {
    day <- paste0("0",day)
    dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month,'-2020')
    dhhs.url <- gsub(" ","",dhhs.url)
  }
  if (!url.exists(dhhs.url)) {
       dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month)
       if (!url.exists(dhhs.url)) {
           dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month)
           if (!url.exists(dhhs.url)) {
               dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-', month,'-2020')
           }
       }
  }
  # add media-release to base url
  if (!url.exists(dhhs.url)) {
    url.prefix <- 'media-release-'
    day <- day.bkp
    dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month,'-2020')
  }
  if (!url.exists(dhhs.url)) {
    dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month)
    if (!url.exists(dhhs.url)) {
      dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month)
      if (!url.exists(dhhs.url)) {
        dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month,'-2020')
      }
    }
  }
  if (!url.exists(dhhs.url)) {
    day <- paste0("0",day)
    dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month,'-2020')
    dhhs.url <- gsub(" ","",dhhs.url)
  }
  if (!url.exists(dhhs.url)) {
    dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',day,'-',month)
    if (!url.exists(dhhs.url)) {
      dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-',month)
      if (!url.exists(dhhs.url)) {
        dhhs.url <- paste0('https://www.dhhs.vic.gov.au/',url.prefix,'coronavirus-update-victoria-',weekday,'-',day,'-', month,'-2020')
      }
    }
  }
  if (!url.exists(dhhs.url)){
    return(FALSE)
  }
  return (dhhs.url)
}
```


```{r}
#function to get cases per day
get_data_from_url <- function(day,month,item){
  dhhs.url <- get_dhhs_url(as.character(day),as.character(month))
  con <- url(dhhs.url)
  htmlcode <- readLines(con)
  close.connection(con)
  if (item == 'html') {
    return (htmlcode)
  }
  if (item == 'cases'){
    cases_match <- str_subset(htmlcode,"total number of coronavirus|total number of cases")
    cases_match <- cleanHTML(cases_match)
    cases_match <- cases_match[cases_match != ""]
    cases <- as.numeric(str_replace_all(unlist(str_split(unlist(str_split(cases_match[1],"Victoria is | now at "))[2]," "))[1],",",""))
    return(cases)
  }
  if (item == 'patients'){
    pat_match <- str_subset(htmlcode," in intensive care|recovered")
    pat_clean <- gsub("COVID-19","COVID",gsub(",","",unlist(str_split(pat_match,"[.] "))))
    pat_clean <- cleanHTML(pat_clean)
    # remove sentences without needed information (community transmission and tests)
    pat_clean <- pat_clean[!str_detect(pat_clean,"community|tests|ctive cases")]
    # split by words
    pat_parsed <- unlist(str_split(pat_clean," "))
    patients <- as.numeric(unlist(regmatches(pat_parsed, gregexpr("[[:digit:]]+", pat_parsed))))
    if(any(patients > 50000)) {patients <- patients[patients < 50000]}
    # remove tests, as some times it gets selected
    # manually get from words to numbers the hospital and icu cases
    if (length(patients) < 3){
      # get numbers from all words and keep only the ones with numbers
      extra_num <- sapply(pat_parsed,word2num)[!is.na(sapply(pat_parsed,word2num))]
      if (length(patients) == 1){
        patients <- c(extra_num,patients)
      } else {
        # patients <- c(patients[1],word2num(pat_parsed[which (pat_parsed == 'including') +1]),patients[2])
        patients <- c(patients[1],extra_num[1],patients[2])
      }
    }
    # sometimes hospital and icu have word instead of number, just to fix the order, as icu should always be smaller
    if (length(patients) == 3 && patients[1] < patients[2]) {patients <- patients[c(2,1,3)]}
    return(patients[c(1:3)])
  }
  #check deaths (lots of differences on the first reports) will try to take all of them
  if (item == 'deaths'){
    # fix covid19 so it doesnt account as a number
    # htmlcode <- gsub("COVID-19","COVID",htmlcode)
    max_deaths <- 30 #to check death numbers are not artifacts
    # check word died
    death_match <- str_subset(htmlcode,"died")
    # clean html tags
    death_match <- cleanHTML(death_match)
    # split everything on words
    death_clean <- unlist(str_split(death_match," "))
    death_clean <- death_clean[!death_clean == ""]
    # check if there are numbers on the splitted items
    death_n <- as.numeric(death_clean[numbers_only(death_clean)])
    # double check if the numbers are more than 5 times of previous day, as it is an artifact, then
    if (all(death_n[!is.na(death_n)] > max_deaths)) {
      death_n <- NULL
    }
    # if not, check if some of the words are numbers in letters
    if (length(death_n) == 0){
      death_n <- as.numeric(unlist(lapply(death_clean,word2num)))
    }
    deaths <- death_n[!is.na(death_n)][1]
    # if still, there is no option, change the key word to death and repeat the same
    if (length(death_match) == 0 || length(death_n[!is.na(death_n)]) == 0) {
        death_match <- str_subset(htmlcode,"death")
        # clean html tags
        death_match <- cleanHTML(death_match)
        # there are different matches, normally. check one by one
        for (death_match_i in death_match) {
          # split and remove empty spaces in the beginning
          death_clean <- unlist(str_split(death_match_i," "))
          death_clean <- death_clean[!death_clean == ""]
          # check if numbers
          death_n <- as.numeric(death_clean[numbers_only(death_clean)])
          # death_n <- as.numeric(unlist(regmatches(death_clean, gregexpr("[[:digit:]]+", death_clean))))
          # double check if the numbers are more than 5 times of previous day, as it is an artifact, then
          if (all(death_n[!is.na(death_n)] > max_deaths)) {
            death_n <- NULL
          }
          if (length(death_n) == 0){
            death_n <- as.numeric(unlist(lapply(death_clean,word2num)))
            if (length(death_n[!is.na(death_n)]) != 0){
              break
            }
          }
        }
      deaths <- death_n[!is.na(death_n)][1]
    }
    # if it still persists, it means there are no deaths
    if (length(death_match)==0) {
      deaths <- 0
      return(deaths)
    }
    return(deaths)
  }
  if (item == 'community'){
    # check word died
    comm_match <- str_subset(str_subset(htmlcode,"transmission|source"),"community|unknown")

    # clean html tags
    comm_match <- cleanHTML(comm_match)
    # split everything on words
    comm_clean <- unlist(str_split(comm_match,"transmission. "))[1]
    comm_clean <- unlist(str_split(comm_clean," "))
    comm_clean <- comm_clean[!comm_clean == ""]
    # check if there are numbers on the splitted items
    comm_n <- as.numeric(comm_clean[numbers_only(comm_clean)])
    # check if no results, and get word2num
    if (length(comm_n) == 0){
      comm_n <- as.numeric(unlist(lapply(comm_clean,word2num)))
    }
    comm <- comm_n[!is.na(comm_n)][1]
    # some times, there is no "community" word on the transmission lines, fix it by changing "community" to "unknown"
    if (sum(!is.na(comm)) == 0) {
      comm_match <- cleanHTML(str_subset(str_subset(htmlcode,"transmission"),"unknown"))
      comm_clean <- unlist(str_split(unlist(str_split(comm_match,"transmission. "))[1]," "))
      comm_n <- as.numeric(comm_clean[numbers_only(comm_clean)])
      if (length(comm_n) == 0){ comm_n <- as.numeric(unlist(lapply(comm_clean,word2num))) }
      comm <- comm_n[!is.na(comm_n)][1]
    }
    return(comm)
  }
}
```

<!-- ## initialize matrix with dates to calculate -->

```{r}
# # # initialize covid_data as of 27/04 and save it as covid_data.rda
# startdate <- as.Date("2020-03-23")
# enddate <- as.Date(Sys.Date())
# today <- unlist(str_split(tolower(gsub(" 0", " ",format(enddate, format="%B %d")))," "))
# #get end date
# if (get_dhhs_url(today[2],today[1])==FALSE){enddate <- enddate - 1}
# sel_dates <- seq(startdate, enddate, by="days")
# #fix for 16 april and 17 may
# sel_dates[sel_dates == "2020-04-16"] <- as.Date("2020-04-13")
# sel_dates[sel_dates == "2020-05-17"] <- as.Date("2020-04-16")
# days_to_plot <- tolower(gsub(" 0", " ",format(sel_dates, format="%B %d")))
# covid_data <- as.data.frame(do.call(rbind, str_split(days_to_plot," ")),stringsAsFactors =FALSE)
# covid_data <- cbind(covid_data,sel_dates)
# colnames(covid_data) <- c("month","day","date")
# covid_data$cases <- apply(covid_data,1,function(x) get_data_from_url(x['day'],x['month'],item="cases"))
# covid_data <- cbind(covid_data,setNames(data.frame(t(apply(covid_data,1,
#                              function(x) get_data_from_url(x['day'],x['month'],item="patients")))),
#                              c("hospital","icu","recovered")))
# covid_data$deaths <- apply(covid_data,1,function(x) get_data_from_url(x['day'],x['month'],item="deaths"))
# covid_data$community <- apply(covid_data,1,function(x) get_data_from_url(x['day'],x['month'],item="community"))
# covid_data <- fix_old_reports(covid_data)
# save(covid_data, file = "covid_data.rda")
# # covid_data
```

```{r}
get_today_data <- function(today.raw){
  today <- unlist(str_split(tolower(gsub(" 0", " ",format(today.raw, format="%B %d")))," "))
  if (get_dhhs_url(today[2],today[1])!=FALSE & !any(covid_data$date == today.raw)){
    update.covid <- setNames(data.frame(matrix(today,ncol=2)),c("month","day"))
    update.covid$date <- today.raw
    update.covid$cases <- get_data_from_url(update.covid$day, update.covid$month,item='cases')
    update.covid <- cbind(update.covid,setNames(data.frame(t(get_data_from_url(update.covid$day, update.covid$month,item='patients'))),c("hospital","icu","recovered")))
    update.covid$deaths <- get_data_from_url(update.covid$day, update.covid$month,item='deaths')
    update.covid$community <- get_data_from_url(update.covid$day, update.covid$month,item='community')
    return(update.covid)
  }
}

# if (get_dhhs_url(today[2],today[1])!=FALSE && !any(covid_data$date == today.raw)){
  #   update.covid <- setNames(data.frame(matrix(today,ncol=2)),c("month","day"))
  #   update.covid$date <- today.raw
  #   update.covid$cases <- get_data_from_url(update.covid$day, update.covid$month,item='cases')
  #   update.covid <- cbind(update.covid,setNames(data.frame(t(get_data_from_url(update.covid$day, update.covid$month,item='patients'))),c("hospital","icu","recovered")))
  #   update.covid$deaths <- get_data_from_url(update.covid$day, update.covid$month,item='deaths')
  #   update.covid$community <- get_data_from_url(update.covid$day, update.covid$month,item='community')
  #   covid_data <- rbind(covid_data,update.covid)
  # }
```


```{r}
# new process:
# load covid_data.rda
# check if today's link exists
# check if today has already been computed in covid_data
# run today and append it to covid_data
# save covid_data

load("covid_data.rda")
today.raw <- as.Date(Sys.Date())
today <- unlist(str_split(tolower(gsub(" 0", " ",format(today.raw, format="%B %d")))," "))
months <- 1:12
names(months) <- tolower(month.name)
today.weekday <- tolower(weekdays(as.Date(paste0(2020,"-",unname(months[today[1]]),"-",today[2]))))

# check if monday and then check if weekend was calculated
if (today.weekday == 'monday'){
  today.sat <- today.raw - 2
  update.covid <- get_today_data(today.sat)
  covid_data <- rbind(covid_data,update.covid)
  today.sun <- today.raw - 1
  update.covid <- get_today_data(today.sun)
  covid_data <- rbind(covid_data,update.covid)
} 

if (get_dhhs_url(today[2],today[1])!=FALSE & !any(covid_data$date == today.raw)){
  update.covid <- get_today_data(today.raw)
  covid_data <- rbind(covid_data,update.covid)
  save(covid_data, file = "covid_data.rda")
}
```

```{r}
covid_data <- covid_data %>%
  mutate(
    active = cases - recovered - deaths,
    recovered_perc = round(recovered / cases * 100,1),
    community_perc_total = round(community / cases * 100,1),
    cases_new = c(0,diff(cases)),
    community_new = c(0,diff(community)),
    community_perc_new = round(community_new / cases_new * 100,1),
  )
# covid_data
```

<!-- R0 approx -->

```{r}
# https://www.ub.edu/aqr/covid19/?p=349&lang=en#_ftn1
y <- covid_data$cases_new
t <- length(y)
k <- 14
q <- 14
# up <- sum(y[c((t-7):t)])
# down <- sum(y[c((t-7-7):(t-7))])
# ro <- round(up/down,2)
covid_data$ro <- NA
# get ro for all days
for (d in c((k+q):t)){
  up <- sum(y[c((d-q):d)])
  down <- sum(y[c((d-q-k):(d-k))])
  covid_data$ro[d] <- round(up/down,2)
}
```

```{r}
# mycols <- c("black", "firebrick","green","blue","orange","purple")
mycols <- c('black','#66C2A5','#FC8D62','#8DA0CB','#E78AC3','#A6D854','#FFD92F','#E5C494','#B3B3B3')
mycols <- c('black', brewer.pal(n = 8, name = 'Dark2'),'darkred')
mytext_x <- format(covid_data$date,format="%b")
mytext_x[duplicated(mytext_x)] <- ""
mytext_x <- paste(mytext_x,as.numeric(format(covid_data$date,format="%e")))
# remove all odd numbers in x axis for better readability
for (i in c(1:length(mytext_x))) {if (i %% 2 == 0 & !str_detect(mytext_x[i],"[a-z]")){mytext_x[i] <- " "}}
covid_data$i <- as.numeric(rownames(covid_data))
fig <- plot_ly(data = covid_data,x = ~i)
fig <- fig %>% add_trace(y = ~cases, name = 'Cases',type='scatter', mode = 'lines',line = list(color = mycols[1]))
fig <- fig %>% add_trace(y = ~cases_new, name = 'Daily Cases', type = 'bar', yaxis = 'y2',marker = list(color = rgb(0,0,0,0.2)))
fig <- fig %>% add_trace(y = ~recovered, name = 'Recovered',type='scatter', mode = 'lines',line = list(color = mycols[2]))
fig <- fig %>% add_trace(y = ~active, name = 'Active',type='scatter', yaxis='y2', mode = 'lines',line = list(color = mycols[3]))
fig <- fig %>% add_trace(y = ~community, name = 'Community',type='scatter', mode = 'lines',yaxis = 'y2',line = list(color = mycols[4]))
fig <- fig %>% add_trace(y = ~hospital, name = 'Hospital',type='scatter', mode = 'lines',yaxis = 'y2',line = list(color = mycols[5]))
fig <- fig %>% add_trace(y = ~icu, name = 'ICU',type='scatter', mode = 'lines',yaxis = 'y2',line = list(color = mycols[6]))
fig <- fig %>% add_trace(y = ~deaths, name = 'Deaths',type='scatter', mode = 'lines',yaxis = 'y2',line = list(color = mycols[7]))
fig <- fig %>% add_trace(y = ~ro, name = 'R0',type='scatter', mode = 'lines',yaxis = 'y3',line = list(color = mycols[10]))
my_ylim <- 4000
fig <- fig %>% layout(title = '',
                      xaxis = list(title = "Date",tickangle=-60,
                                   # type='date',
                                   # tickformat = '%b %e',
                                   # range = ~date,
                                   tickmode="array",
                                   tickvals=covid_data$i,
                                   ticktext=mytext_x,
                                   tickfont=list(size=10),
                                   autotick = F,
                                   domain = c(0,0.92),
                                   linewidth = 3,showgrid=T,
                                   linecolor='black',linewidth=0.5,mirror=T),
                      yaxis = list(side = 'left', title = 'Total / Recovered Cases (#)',
                                   linewidth = 3,
                                   range=c(0,my_ylim),
                                   linecolor='black',linewidth=0.5,mirror=T),
                      yaxis2 = list(side = 'right', overlaying = "y", anchor='x',
                                    title = 'Active & Daily Cases / Hospital / ICU \n Deaths / Community (# people)',
                                    linewidth = 3,
                                    showgrid=FALSE, zeroline=T, range=c(0,my_ylim/5), textangle = 90),
                      yaxis3 = list(side = 'right', overlaying = "y",
                                    tickfont=list(color=mycols[10]), titlefont=list(color=mycols[10]),
                                    title = 'R0', anchor='free', position=1, showline=TRUE,linecolor = mycols[10],
                                    linewidth = 3,
                                    showgrid=FALSE, zeroline=T, range=c(0,5), textangle = 90),
                      margin = list(r = 25),
                      legend = list(x = 0.01, y = 0.99, bordercolor = "black", borderwidth=0.5),
                      hovermode='x')
# fig
# https://plotly.com/r/axes/
# https://plotly.com/r/graphing-multiple-chart-types/
# https://plotly.com/r/reference/#layout-xaxis-tickmode
```

<!-- ################ WEBSITE SETUP ############## -->
<!-- icons from https://fontawesome.com/icons?d=gallery&v=5.0.0&m=free -->

Row {data-height=80}
---------------------
```{r}
valueBox(
    value = tags$h2(paste0("COVID-19 in Victoria: ",format(Sys.Date(), format="%A, %B %e, %Y"))),
    color = ""
)
daily.status <- covid_data[dim(covid_data)[1],]
yesterday <- covid_data[dim(covid_data)[1]-1,]
maincolor <- 'gray'
updatecolor <- 'darkgray'
```

Row {data-height=100}
---------------------

### Total cases {.value-box}

```{r}
valueBox(
    value = daily.status$cases,
    icon = "fa-user",
    color = maincolor
  )
```

### Total deaths {.value-box}

```{r}
  valueBox(daily.status$deaths,
           icon = "fa-times-circle",
    color=maincolor
    )
```

### Recovered people {.value-box}

```{r}
valueBox(
    value = daily.status$recovered,
    icon = "fa-user-check",
    color=maincolor
)
```

### Active cases {.value-box}

```{r}
valueBox(
    value = daily.status$active,
    icon = "fa-user-clock",
    color=maincolor
)
```

### Patients in hospital {.value-box}

```{r}
valueBox(
    value = daily.status$hospital,
    icon = "fa-stethoscope",
    color=maincolor
)
```

### Patients in ICU {.value-box}

```{r}
valueBox(
    value = daily.status$icu,
    icon = "fa-ambulance",
    color=maincolor
)
```

### Community transmission {.value-box}

```{r}
valueBox(
    value = daily.status$community,
    icon = "fa-users",
    color=maincolor
)
```

Row {data-height=45}
---------------------

### Total cases {.value-box .no-mobile}

```{r}
v <- daily.status$cases_new
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Total deaths {.value-box .no-mobile}

```{r}
v <- daily.status$deaths - yesterday$deaths
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Recovered people {.value-box .no-mobile}

```{r}
v <- daily.status$recovered - yesterday$recovered
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Active cases {.value-box .no-mobile}

```{r}
v <- daily.status$active - yesterday$active
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Patients in hospital {.value-box .no-mobile}

```{r}
v <- daily.status$hospital - yesterday$hospital
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Patients in ICU {.value-box .no-mobile}

```{r}
v <- daily.status$icu - yesterday$icu
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

### Community transmission {.value-box .no-mobile}

```{r}
v <- daily.status$community - yesterday$community
valueBox(
    value = "",
    caption = tags$h6(if (v >= 0) sprintf("%+d", v) else v),
    color = updatecolor
  )
```

Row {data-height=50}
---------------------
```{r}
valueBox(
    value = tags$h3("Current R0"),
    color = ""
)
```

### {.value-box .no-mobile .r0}

```{r}
v <- daily.status$ro
valueBox(
    value = v,
    # caption = tags$h6(v),
    icon = "fa-exclamation-triangle",
    color = 'lightcoral'
)
```

Row {data-height=5}
---------------------

Row {data-height=40}
---------------------

```{r}
valueBox(
    value = tags$h4("Weekly Changes"),
    color = ""
)
week.changes <- as.data.frame(t(as.numeric(daily.status[,-c(1,3)]) - as.numeric(covid_data[dim(covid_data)[1]-7,-c(1,3)])))
colnames(week.changes) <- colnames(daily.status)[-c(1,3)]
```

Row {data-height=50}
---------------------

### {.value-box .no-mobile}

```{r}
v = week.changes$cases
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 50) "fa-angle-double-up" else "fa-angle-up",
    color = if (v > 50) "firebrick" else "warning",
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$deaths
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 5) "fa-angle-double-up" else if (v > 0) "fa-angle-up" else "fa-equals",
    color = if (v > 5) "firebrick" else if (v > 0) "warning" else "success"
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$recovered
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 200) "fa-angle-double-up" else if (v > 0) "fa-angle-up" else "fa-equals",
    color = if (v >= 200) "success" else "primary"
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$active
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$hospital
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$icu
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = week.changes$community
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 10) "fa-angle-double-up" else if (v > 0) "fa-angle-up" else "fa-equals",
    color = if (v > 10) "firebrick" else if (v > 0) "warning" else "success"
  )
```


Row {data-height=40}
---------------------

```{r}
valueBox(
    value = tags$h4("Monthly Changes"),
    color = ""
)
month.changes <- as.data.frame(t(as.numeric(daily.status[,-c(1,3)]) - as.numeric(covid_data[dim(covid_data)[1]-30,-c(1,3)])))
colnames(month.changes) <- colnames(daily.status)[-c(1,3)]
```


Row {data-height=50}
---------------------

### {.value-box .no-mobile}

```{r}
v = month.changes$cases
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 50) "fa-angle-double-up" else "fa-angle-up",
    color = if (v > 50) "firebrick" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$deaths
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 5) "fa-angle-double-up" else if (v > 0) "fa-angle-up" else "fa-equals",
    color = if (v > 5) "firebrick" else if (v > 0) "warning" else "success"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$recovered
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 200) "fa-angle-double-up" else "fa-angle-up",
    color = if (v >= 200) "success" else "primary"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$active
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$hospital
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$icu
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 0) "fa-angle-up" else if (v < 0) "fa-angle-down" else "fa-equals",
    color = if (v <= 0) "success" else "warning"
  )
```

### {.value-box .no-mobile}

```{r}
v = month.changes$community
valueBox(
    value = if (v >= 0) sprintf("%+d", v) else v,
    icon = if (v > 10) "fa-angle-double-up" else if (v > 0) "fa-angle-up" else "fa-equals",
    color = if (v > 10) "firebrick" else if (v > 0) "warning" else "success"
  )
```

Row {data-height=30}
---------------------

Row {data-height=500}
---------------------

###

```{r}
fig
```

Row {data-height=30}
---------------------
```{r}
update.date <- format(Sys.Date(), format="%A, %B %e at")
update.time <- format(Sys.time(), format="%H:%M")
update.text <- paste("Last updated on",update.date,update.time)
valueBox(
    value = tags$h5(update.text),
    color = ""
)
```

Row {data-height=20}
---------------------

##### Created by [\@RuizCSergio](http://twitter.com/RuizCSergio)
